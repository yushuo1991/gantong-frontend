name: 部署到服务器

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 部署到服务器
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "=========================================="
          echo "开始部署感统训练中心..."
          echo "=========================================="
          
          # 进入部署目录
          cd /www/wwwroot
          
          # 克隆或更新代码
          if [ -d "gantong" ]; then
            echo "更新现有代码..."
            cd gantong
            git pull origin master
          else
            echo "首次部署，克隆代码..."
            git clone https://github.com/${{ github.repository }}.git gantong
          fi
          
          # 配置 Nginx
          echo "配置 Nginx..."
          cat > /www/server/panel/vhost/nginx/gantong.conf << 'NGINXEOF'
          server {
              listen 80;
              server_name gantong.yushuo.click;
              root /www/wwwroot/gantong;
              index index.html;
              access_log /www/wwwlogs/gantong_access.log;
              error_log /www/wwwlogs/gantong_error.log;
              charset utf-8;
              gzip on;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;
              location / {
                  try_files $uri $uri/ /index.html;
              }
              location ~ \.html$ {
                  add_header Cache-Control "no-cache, must-revalidate";
                  expires -1;
              }
              location ~ /\. {
                  deny all;
              }
          }
          NGINXEOF
          
          # 重载 Nginx
          echo "重载 Nginx..."
          nginx -t && nginx -s reload
          
          # 显示结果
          echo "=========================================="
          echo "✅ 部署完成！"
          echo "=========================================="
          echo "文件列表："
          ls -lh /www/wwwroot/gantong/*.html
          echo ""
          echo "访问地址: http://gantong.yushuo.click"

